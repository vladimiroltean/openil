From db3c0043d8562d1681abe365492cff1edd7829da Mon Sep 17 00:00:00 2001
From: Alex Marginean <alexandru.marginean@nxp.com>
Date: Wed, 8 Jan 2020 15:21:53 +0200
Subject: [PATCH 07/26] drivers: net: mscc_ocelot: don't flood unicast traffic
 to cpu

Switch cpu port doesn't learn MAC addresses and the local bridge dev_addr
must be explicitly added to the bridge.
This is done whenever a port is added to a bridge, ports following the
1st one will just overwrite the same entry.

Signed-off-by: Alex Marginean <alexandru.marginean@nxp.com>
---
 drivers/net/ethernet/mscc/ocelot.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/drivers/net/ethernet/mscc/ocelot.c b/drivers/net/ethernet/mscc/ocelot.c
index 4261de0c9ba5..b23e0aff1320 100644
--- a/drivers/net/ethernet/mscc/ocelot.c
+++ b/drivers/net/ethernet/mscc/ocelot.c
@@ -1677,6 +1677,8 @@ static int ocelot_port_obj_del(struct net_device *dev,
 int ocelot_port_bridge_join(struct ocelot *ocelot, int port,
 			    struct net_device *bridge)
 {
+	struct ocelot_port *ocelot_port = ocelot->ports[port];
+
 	if (!ocelot->bridge_mask) {
 		ocelot->hw_bridge_dev = bridge;
 	} else {
@@ -1688,6 +1690,12 @@ int ocelot_port_bridge_join(struct ocelot *ocelot, int port,
 
 	ocelot->bridge_mask |= BIT(port);
 
+	/* Direct CPU traffic to PCU port, this should override any existing
+	 * entries
+	 */
+	ocelot_mact_learn(ocelot, PGID_CPU, bridge->dev_addr, ocelot_port->pvid,
+			  ENTRYTYPE_LOCKED);
+
 	return 0;
 }
 EXPORT_SYMBOL(ocelot_port_bridge_join);
-- 
2.17.1

