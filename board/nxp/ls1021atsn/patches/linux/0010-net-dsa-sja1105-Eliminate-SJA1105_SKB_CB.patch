From 311ad72ae01a5c20fb5d3bbcb21f1be6e1ba1ad1 Mon Sep 17 00:00:00 2001
From: Vladimir Oltean <olteanv@gmail.com>
Date: Fri, 22 Nov 2019 22:10:59 +0200
Subject: [PATCH buildroot 10/18] net: dsa: sja1105: Eliminate SJA1105_SKB_CB

Signed-off-by: Vladimir Oltean <olteanv@gmail.com>
---
 drivers/net/dsa/sja1105/sja1105_ptp.c | 6 +-----
 include/linux/dsa/sja1105.h           | 7 -------
 net/dsa/tag_sja1105.c                 | 6 +++++-
 3 files changed, 6 insertions(+), 13 deletions(-)

diff --git a/drivers/net/dsa/sja1105/sja1105_ptp.c b/drivers/net/dsa/sja1105/sja1105_ptp.c
index fec9fb352c50..1e5acb92fd81 100644
--- a/drivers/net/dsa/sja1105/sja1105_ptp.c
+++ b/drivers/net/dsa/sja1105/sja1105_ptp.c
@@ -391,11 +391,7 @@ static long sja1105_rxtstamp_work(struct ptp_clock_info *ptp)
 		}
 
 		shwt = skb_hwtstamps(skb);
-		*shwt = (struct skb_shared_hwtstamps) {0};
-
-		ts = SJA1105_SKB_CB(skb)->meta_tstamp;
-		ts = sja1105_tstamp_reconstruct(ds, ticks, ts);
-
+		ts = sja1105_tstamp_reconstruct(ds, ticks, shwt->hwtstamp);
 		shwt->hwtstamp = ns_to_ktime(sja1105_ticks_to_ns(ts));
 		netif_rx_ni(skb);
 	}
diff --git a/include/linux/dsa/sja1105.h b/include/linux/dsa/sja1105.h
index c0b6a603ea8c..b5c2b0e300ed 100644
--- a/include/linux/dsa/sja1105.h
+++ b/include/linux/dsa/sja1105.h
@@ -45,13 +45,6 @@ struct sja1105_tagger_data {
 	unsigned long state;
 };
 
-struct sja1105_skb_cb {
-	u32 meta_tstamp;
-};
-
-#define SJA1105_SKB_CB(skb) \
-	((struct sja1105_skb_cb *)DSA_SKB_CB_PRIV(skb))
-
 struct sja1105_port {
 	struct sja1105_tagger_data *data;
 	struct dsa_port *dp;
diff --git a/net/dsa/tag_sja1105.c b/net/dsa/tag_sja1105.c
index 63ef2a14c934..9bc2f117a4c2 100644
--- a/net/dsa/tag_sja1105.c
+++ b/net/dsa/tag_sja1105.c
@@ -115,10 +115,14 @@ static void sja1105_transfer_meta(struct sk_buff *skb,
 				  const struct sja1105_meta *meta)
 {
 	struct ethhdr *hdr = eth_hdr(skb);
+	struct skb_shared_hwtstamps *shwt;
+
+	shwt = skb_hwtstamps(skb);
+	*shwt = (struct skb_shared_hwtstamps) {0};
 
 	hdr->h_dest[3] = meta->dmac_byte_3;
 	hdr->h_dest[4] = meta->dmac_byte_4;
-	SJA1105_SKB_CB(skb)->meta_tstamp = meta->tstamp;
+	shwt->hwtstamp = meta->tstamp;
 }
 
 /* This is a simple state machine which follows the hardware mechanism of
-- 
2.17.1

