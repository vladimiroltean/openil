From de09827dd773312e60dbcb81cf5b811b76687e09 Mon Sep 17 00:00:00 2001
From: Vladimir Oltean <olteanv@gmail.com>
Date: Thu, 9 Jan 2020 03:13:27 +0200
Subject: [PATCH] spi: spi-fsl-dspi: add tracepoints for rxdata

Signed-off-by: Vladimir Oltean <olteanv@gmail.com>
---
 drivers/spi/Makefile             |  1 +
 drivers/spi/spi-fsl-dspi-trace.h | 36 ++++++++++++++++++++++++++++++++
 drivers/spi/spi-fsl-dspi.c       |  4 ++++
 3 files changed, 41 insertions(+)
 create mode 100644 drivers/spi/spi-fsl-dspi-trace.h

diff --git a/drivers/spi/Makefile b/drivers/spi/Makefile
index bb49c9e6d0a0..ceee47962cd0 100644
--- a/drivers/spi/Makefile
+++ b/drivers/spi/Makefile
@@ -42,6 +42,7 @@ obj-$(CONFIG_SPI_EP93XX)		+= spi-ep93xx.o
 obj-$(CONFIG_SPI_FALCON)		+= spi-falcon.o
 obj-$(CONFIG_SPI_FSL_CPM)		+= spi-fsl-cpm.o
 obj-$(CONFIG_SPI_FSL_DSPI)		+= spi-fsl-dspi.o
+CFLAGS_spi-fsl-dspi.o			:= -I$(src)
 obj-$(CONFIG_SPI_FSL_LIB)		+= spi-fsl-lib.o
 obj-$(CONFIG_SPI_FSL_ESPI)		+= spi-fsl-espi.o
 obj-$(CONFIG_SPI_FSL_LPSPI)		+= spi-fsl-lpspi.o
diff --git a/drivers/spi/spi-fsl-dspi-trace.h b/drivers/spi/spi-fsl-dspi-trace.h
new file mode 100644
index 000000000000..db97c10a3adf
--- /dev/null
+++ b/drivers/spi/spi-fsl-dspi-trace.h
@@ -0,0 +1,36 @@
+#undef TRACE_SYSTEM
+#define TRACE_SYSTEM	fsl_dspi
+
+#if !defined(_FSL_DSPI_TRACE_H) || defined(TRACE_HEADER_MULTI_READ)
+#define _FSL_DSPI_TRACE_H
+
+#include <linux/spi/spi.h>
+#include <linux/tracepoint.h>
+
+TRACE_EVENT(dspi_fifo_read,
+	TP_PROTO(u32 rxdata, struct spi_transfer *xfer),
+
+	TP_ARGS(rxdata, xfer),
+
+	TP_STRUCT__entry(
+		__field(u32, rxdata)
+		__field(void *, xfer)
+	),
+
+	TP_fast_assign(
+		__entry->rxdata = rxdata;
+		__entry->xfer = xfer;
+	),
+
+	TP_printk("rxdata=0x%08x xfer=%p",
+		  __entry->rxdata, __entry->xfer)
+);
+
+#endif /* _FSL_DSPI_TRACE_H */
+
+/* This must be outside ifdef _FSL_DSPI_TRACE_H */
+#undef TRACE_INCLUDE_PATH
+#define TRACE_INCLUDE_PATH .
+#undef TRACE_INCLUDE_FILE
+#define TRACE_INCLUDE_FILE	spi-fsl-dspi-trace
+#include <trace/define_trace.h>
diff --git a/drivers/spi/spi-fsl-dspi.c b/drivers/spi/spi-fsl-dspi.c
index 217320376c2d..4f009b559558 100644
--- a/drivers/spi/spi-fsl-dspi.c
+++ b/drivers/spi/spi-fsl-dspi.c
@@ -5,6 +5,9 @@
 // Freescale DSPI driver
 // This file contains a driver for the Freescale DSPI
 
+#define CREATE_TRACE_POINTS
+#include "spi-fsl-dspi-trace.h"
+
 #include <linux/clk.h>
 #include <linux/delay.h>
 #include <linux/dmaengine.h>
@@ -597,6 +600,7 @@ static u32 fifo_read(struct fsl_dspi *dspi)
 	u32 rxdata = 0;
 
 	regmap_read(dspi->regmap, SPI_POPR, &rxdata);
+	trace_dspi_fifo_read(rxdata, dspi->cur_transfer);
 	return rxdata;
 }
 
-- 
2.17.1

